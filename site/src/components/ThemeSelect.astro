---
import { Icon } from '@astrojs/starlight/components';

const themeOrder: Array<'light' | 'dark' | 'auto'> = ['light', 'dark', 'auto'];
const accessibleLabel =
  typeof Astro.locals?.t === 'function' ? Astro.locals.t('themeSelect.accessibleLabel') : 'Switch theme';
---

<starlight-theme-select>
	<button
		type="button"
		class="theme-cycle-btn"
		aria-label={accessibleLabel}
		title={accessibleLabel}
	>
		<Icon name="sun" class="label-icon" />
	</button>
</starlight-theme-select>

{/* Inlined to avoid FOUC. Uses global scope from `ThemeProvider.astro` */}
<script is:inline>
	StarlightThemeProvider.updatePickers();
</script>

<script>
	type Theme = 'auto' | 'dark' | 'light';

	const storageKey = 'starlight-theme';
	const themeOrder: Theme[] = ['light', 'dark', 'auto'];

	const parseTheme = (theme: unknown): Theme =>
		theme === 'auto' || theme === 'dark' || theme === 'light' ? theme : 'auto';

	const loadTheme = (): Theme =>
		parseTheme(typeof localStorage !== 'undefined' && localStorage.getItem(storageKey));

	function storeTheme(theme: Theme): void {
		if (typeof localStorage !== 'undefined') {
			localStorage.setItem(storageKey, theme === 'light' || theme === 'dark' ? theme : '');
		}
	}

	const getPreferredColorScheme = (): Theme =>
		matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';

	function onThemeChange(theme: Theme): void {
		StarlightThemeProvider.updatePickers(theme);
		document.documentElement.dataset.theme = theme === 'auto' ? getPreferredColorScheme() : theme;
		storeTheme(theme);
	}

	function getNextTheme(current: Theme): Theme {
		const idx = themeOrder.indexOf(current);
		return themeOrder[(idx + 1) % themeOrder.length];
	}

	matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
		if (loadTheme() === 'auto') onThemeChange('auto');
	});

	class StarlightThemeSelect extends HTMLElement {
		constructor() {
			super();
			onThemeChange(loadTheme());
			const btn = this.querySelector('button.theme-cycle-btn');
			btn?.addEventListener('click', () => {
				const next = getNextTheme(loadTheme());
				onThemeChange(next);
			});
		}
	}
	customElements.define('starlight-theme-select', StarlightThemeSelect);
</script>

<style>
	@layer starlight.core {
		.theme-cycle-btn {
			--sl-label-icon-size: 0.875rem;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 2.25rem;
			height: 2.25rem;
			padding: 0;
			border: none;
			background: transparent;
			color: var(--sl-color-gray-1);
			cursor: pointer;
			border-radius: 0.375rem;
			transition: color 0.15s ease, background-color 0.15s ease;
		}

		.theme-cycle-btn:hover {
			color: var(--sl-color-gray-2);
			background-color: var(--sl-color-bg-accent);
		}

		.theme-cycle-btn:focus-visible {
			outline: 2px solid var(--sl-color-accent);
			outline-offset: 2px;
		}

		.theme-cycle-btn .label-icon {
			width: var(--sl-label-icon-size);
			height: var(--sl-label-icon-size);
		}

		@media (min-width: 50rem) {
			.theme-cycle-btn .label-icon {
				font-size: var(--sl-text-sm);
			}
		}
	}
</style>
